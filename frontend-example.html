<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelance Platform - Real-time Notifications</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .notification {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            animation: slideIn 0.3s ease-in;
        }
        .notification.hire {
            background: #e8f5e8;
            border-color: #4caf50;
        }
        .notification.bid_received {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .notification.bid_rejected {
            background: #ffebee;
            border-color: #f44336;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .connection-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .connected { background: #e8f5e8; color: #2e7d32; }
        .disconnected { background: #ffebee; color: #c62828; }
        .auth-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        button {
            background: #2196f3;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <h1>Freelance Platform - Real-time Notifications Demo</h1>
    
    <div class="auth-section">
        <h3>Authentication</h3>
        <input type="text" id="tokenInput" placeholder="Enter your JWT token" style="width: 300px;">
        <button onclick="connectSocket()">Connect</button>
        <button onclick="disconnectSocket()">Disconnect</button>
    </div>

    <div id="connectionStatus" class="connection-status disconnected">
        Status: Disconnected
    </div>

    <div>
        <h3>Live Notifications</h3>
        <div id="notifications"></div>
    </div>

    <div style="margin-top: 30px;">
        <h3>How to test:</h3>
        <ol>
            <li>Login to your freelance platform account</li>
            <li>Copy your JWT token from browser storage or API response</li>
            <li>Paste the token above and click "Connect"</li>
            <li>Have someone hire you for a project or place a bid on your gig</li>
            <li>Watch for real-time notifications below!</li>
        </ol>
    </div>

    <script>
        let socket = null;
        let isConnected = false;

        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            isConnected = connected;
            
            if (connected) {
                statusDiv.textContent = 'Status: Connected ✓';
                statusDiv.className = 'connection-status connected';
            } else {
                statusDiv.textContent = 'Status: Disconnected ✗';
                statusDiv.className = 'connection-status disconnected';
            }
        }

        function connectSocket() {
            const token = document.getElementById('tokenInput').value.trim();
            
            if (!token) {
                alert('Please enter your JWT token');
                return;
            }

            if (socket) {
                socket.disconnect();
            }

            // Connect to Socket.io server
            socket = io('http://localhost:5000', {
                auth: {
                    token: token
                }
            });

            socket.on('connect', () => {
                console.log('Connected to server');
                updateConnectionStatus(true);
                addNotification('System', 'Connected to notification server', 'system');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
                addNotification('System', 'Disconnected from notification server', 'system');
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                updateConnectionStatus(false);
                addNotification('System', `Connection error: ${error.message}`, 'error');
            });

            // Listen for notifications
            socket.on('notification', (notification) => {
                console.log('Received notification:', notification);
                handleNotification(notification);
            });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateConnectionStatus(false);
            }
        }

        function handleNotification(notification) {
            const { type, title, message, data, timestamp } = notification;
            
            // Show browser notification if permission granted
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/favicon.ico'
                });
            }

            // Add to notification list
            addNotification(title, message, type, data, timestamp);

            // Play notification sound (optional)
            playNotificationSound();
        }

        function addNotification(title, message, type, data = null, timestamp = new Date()) {
            const notificationsDiv = document.getElementById('notifications');
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification ${type}`;
            
            const timeStr = new Date(timestamp).toLocaleTimeString();
            
            let content = `
                <strong>${title}</strong><br>
                ${message}<br>
                <small style="color: #666;">${timeStr}</small>
            `;

            if (data) {
                content += `<br><small style="color: #888;">Details: ${JSON.stringify(data, null, 2)}</small>`;
            }

            notificationDiv.innerHTML = content;
            notificationsDiv.insertBefore(notificationDiv, notificationsDiv.firstChild);

            // Remove old notifications (keep only last 10)
            while (notificationsDiv.children.length > 10) {
                notificationsDiv.removeChild(notificationsDiv.lastChild);
            }
        }

        function playNotificationSound() {
            // Create a simple beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Request notification permission on page load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Initialize
        updateConnectionStatus(false);
    </script>
</body>
</html>